![2025-03-07](https://github.com/user-attachments/assets/b0bd84a2-8618-44bd-a7f7-9a3a215481ae)

Youtube-–∑–∞–ø–∏—Å—å –ª–µ–∫—Ü–∏–∏ –æ—Ç ```2025-03-07```: https://youtu.be/dYg2zZPXJTE

# –ú–µ—Ö–∞–Ω–∏–∑–º setjmp()/longjmp()

## ‚Ä¶–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

## –£—Ö —Ç—ã, –ø—Ä–æ–≥—Ä–∞–º–º–∞!

> –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
> 
- –û–¥–∏–Ω –∫–æ–º–ø—å—é—Ç–µ—Ä ‚Äî –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞
- –§–æ–∫—É—Å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–æ–¥–∞

## –í–∞—Å –º–Ω–æ–≥–æ, —è –æ–¥–Ω–∞(–∏–Ω)

> –°–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
> 
- –ú–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º –≤ –æ–¥–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
- –§–æ–∫—É—Å –Ω–∞ —Ä–µ—Å—É—Ä—Å–∞—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
- –ü—Ä–∏–∫–ª–∞–¥–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ—Ç–¥–µ–ª—å–Ω–æ

<aside>
<img src="/icons/conceal_brown.svg" alt="/icons/conceal_brown.svg" width="40px" />

**1950+**

</aside>

<aside>
<img src="/icons/electric-guitar_orange.svg" alt="/icons/electric-guitar_orange.svg" width="40px" />

**1960+**

</aside>

<aside>
<img src="/icons/apple_green.svg" alt="/icons/apple_green.svg" width="40px" />

**–ö—Ç–æ-—Ç–æ –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å** —Ç–æ, —á–µ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø–æ–ª—å–∑—É—é—Ç—Å—è

</aside>

- –ú–µ–Ω—å—à–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –∏ –ø—Ä–æ—á–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤
- –ë–ª–∏–∂–µ –∫ ~~–∑–µ–º–ª–µ~~ –∂–µ–ª–µ–∑—É
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –Ω–∞—à–µ –≤—Å—ë
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
- –ê—Å—Å–µ–º–±–ª–µ—Ä –∑–∞ —É–≥–ª–æ–º
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –¥–æ—Å—Ç—É–ø—ã, –ø–æ—Ç–æ–∫–∏, –ø–∞–º—è—Ç—å –Ω–∞–ø—Ä—è–º—É—é
- –î—Ä–∞–π–≤–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã (–±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ)

> –ó–∞–±—É–¥—å—Ç–µ –≤—Å—ë —Ç–æ, —á–µ–º—É –≤–∞—Å —É—á–∏–ª–∏ –≤ —à–∫–æ–ª–µ ‚Äî –≤–æ—Ç –æ–Ω–æ!
> 

<aside>
<img src="/icons/help-alternate_orange.svg" alt="/icons/help-alternate_orange.svg" width="40px" />

**–î–∞ –∫–∞–∫ –∑–∞–±—ã—Ç—å-—Ç–æ?!**

</aside>

<aside>
<img src="/icons/sign-out_orange.svg" alt="/icons/sign-out_orange.svg" width="40px" />

**–ü–æ—á—É–≤—Å—Ç–≤—É–π –±–æ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∞.** –û—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Ç—ã –∏–∑ 2020-—Ö —Å AI –∏ –∑–æ–æ–ø–∞—Ä–∫–æ–º –∂–µ–ª–µ–∑–∞

</aside>

# –ü–µ—Ä–≤–∞—è –∂–µ—Ä—Ç–≤–∞  ‚Äî –±–µ–∑—É—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥

<aside>
<img src="/icons/thinking_blue.svg" alt="/icons/thinking_blue.svg" width="40px" />

**–ê –≤–æ—Ç –±—ã –Ω–∞–º —É–º–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è!** –†–µ—Å–ø–∞—É–Ω–∏—Ç—å—Å—è. –í–æ–∑—Ä–æ–∂–¥–∞—Ç—å—Å—è. –ö–∞–∫ –≤ –∏–≥—Ä–∞—Ö.

</aside>

- –î–∞-–¥–∞, —ç—Ç–æ `goto()`, –∏ —ç—Ç–æ —Å–µ—Ä—å—ë–∑–Ω–æ
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è **–≥–¥–µ**? –†–µ—Å–ø–∞—É–Ω–∏—Ç—å—Å—è **–∫—É–¥–∞**? –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å **—á—Ç–æ**?
- –ö–∞–∫ –≤–æ–æ–±—â–µ —É—Å—Ç—Ä–æ–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞?

https://en.cppreference.com/w/c/program/setjmp

https://en.cppreference.com/w/c/program/longjmp

```mermaid
flowchart LR

subgraph –ü–∞–º—è—Ç—å
stack(–õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
heap(–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å)
static(static)
text(–ú–∞—à–∏–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)

end

subgraph –†–µ–≥–∏—Å—Ç—Ä—ã_–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
pc(–ê–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
sp(–ê–¥—Ä–µ—Å –≤–µ—Ä—à–∏–Ω—ã —Å—Ç–µ–∫–∞)
bp(–ê–¥—Ä–µ—Å –Ω–∞—á–∞–ª–∞ –∫–∞–¥—Ä–∞)
other(–í—Å—è–∫–æ–µ –¥—Ä—É–≥–æ–µ)
end

pc -.-> |–ß—Ç–æ —è –¥–µ–ª–∞—é —Å–µ–π—á–∞—Å?| text
sp -.-> |–ì–¥–µ –∫–æ–Ω—á–∞–µ—Ç—Å—è —Å—Ç–µ–∫?| stack
bp -.-> |–ì–¥–µ –∫–∞–¥—Ä —Ñ—É–Ω–∫—Ü–∏–∏?| stack

```

<aside>
<img src="/icons/dna_orange.svg" alt="/icons/dna_orange.svg" width="40px" />

**–†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å—Ç–æ–∏—Ç.** –ù–æ –ø–æ—Ç–æ–º.

</aside>

## –£–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º

- `setjmp()` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
- `longjmp()` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —ç—Ç—É —Ç–æ—á–∫—É
- —Ç—É–¥–∞-—Å—é–¥–∞ –ø–µ—Ä–µ–¥–∞—ë–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ç–æ—á–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞

> –¢–æ—á–µ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏ –∫–æ–¥–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ**
> 

## –ù–∏—á–µ–≥–æ –Ω–µ –æ–±–µ—â–∞–µ–º –ø—Ä–æ –¥–∞–Ω–Ω—ã–µ

- –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–∞
- üëæ¬†**–ª–æ–∫–∞–ª—å–Ω—ã–µ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã** üëæ¬†üëæ¬†üëæ
    - —Ç—É—Ç –ø–æ–º–æ–∂–µ—Ç `volatile` ‚Äî –∂—ë—Å—Ç–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–∞–º—è—Ç–∏, –Ω–∏–∫–∞–∫–∏—Ö —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ –∏ –ø—Ä–æ—á–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- —Ñ–∞–π–ª—ã –∏ —Ç. –ø. –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏

<aside>
<img src="/icons/fireworks_green.svg" alt="/icons/fireworks_green.svg" width="40px" />

**–ü—Ä—ã–≥–Ω—É** ¬´–Ω–∞–∑–∞–¥¬ª –∫—É–¥–∞ —Ö–æ—á—É + **–ø–µ—Ä–µ–¥–∞–º** —Ç—É–¥–∞ **–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –∫ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—é

</aside>

```mermaid
flowchart LR

s1(–®–∞–≥ 1)
setjmp([setjmp])
if((‚Ä¢))
s2(–®–∞–≥ 2)
s3(–®–∞–≥ 3)
s4(–®–∞–≥ 4)
longjmp([longjmp])

s1:::def ==> setjmp:::def
setjmp ==> |–≤–æ–∑–≤—Ä–∞—â–∞—é –∫–æ–µ-—á—Ç–æ‚Ä¶| if:::def
if ==> |‚Ä¶—ç—Ç–æ –±—ã–ª 0| s2:::def
s2 -.-> |–æ–π, –≤—Å—ë| longjmp:::poss
longjmp -.->|—Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–π 30| setjmp
s2 --> |–µ–¥–µ–º –¥–∞–ª—å—à–µ| s4:::def
if -.->|‚Ä¶–∞ —Ç–µ–ø–µ—Ä—å —ç—Ç–æ 30| s3:::poss
s3 -.-> |–∏ —Ç—É—Ç –¥–∞–ª—å—à–µ| s4

classDef def fill:#979736,color:#fff;
classDef poss fill:#f0bf4f;
```

# –ö–æ–Ω–µ—á–Ω–æ, –ø—Ä–∏–¥—É–º–∞–ª–∏ —Ç–∏–ø–æ–≤—ã–µ —Ç—Ä—é–∫–∏

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (–∞–Ω–∞–ª–æ–≥ try/catch)

```mermaid
flowchart TB

s0(–î–æ)
subgraph –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
s1(1)
s2(2)
s3(3)
end
s4(–û–±—Ä–∞–±–æ—Ç–∫–∞ –¢-–æ—à–∏–±–∫–∏)
s5(–ü–æ—Å–ª–µ)
if((‚Ä¢))

s0:::step ==> if:::step
if ===> |–Ω–∞—á–∞–ª–æ| s1:::step
s1 ==> |–¥–∞–ª—å—à–µ| s2:::step
s2 ==> |–¥–∞–ª—å—à–µ| s3:::step
s1 -.-> |–æ–π| if
s2 -.-> |–æ–π| if
s3 -.-> |–æ–π| if
s3 ==> |1-2-3 —Å–¥–µ–ª–∞–ª–∏| s5:::step
if -.-> |1-2-3 –Ω–µ –≤—ã—à–ª–æ| s4:::catch
s4 -.-> |–Ω—É –ª–∞–¥–Ω–æ —Ç–æ–≥–¥–∞| s5

linkStyle 0,1,2,3,7 stroke:#979736,stroke-width:4px;
linkStyle 4,5,6,8,9 stroke:#c7642a,stroke-width:2px;
classDef step fill:#fff;
classDef catch fill:#c7642a,color:#fff;

```

```c
#include <stdio.h>
#include <setjmp.h>

jmp_buf env;

void critical_error() {
    printf("–û—à–∏–±–∫–∞! –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥.\n");
    longjmp(env, 1);  // –í–µ—Ä–Ω—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ setjmp()
}

int main() {
    if (setjmp(env) == 0) { // –°—Ä–∞–∑—É –∏ —Å–æ–∑–¥–∞–ª–∏ —Ç–æ—á–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ 
        printf("–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n");
        critical_error();  // –í–º–µ—Å—Ç–æ return –∏—Å–ø–æ–ª—å–∑—É–µ–º longjmp()
    } else {
        printf("–û–±—Ä–∞–±–æ—Ç–∞–ª–∏ –æ—à–∏–±–∫—É!\n");
    }
    return 0;
}
```

### –≠–º—É–ª—è—Ü–∏—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏ (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á)

```mermaid
flowchart LR

subgraph task_1
s1_1((1))
s2_1((2))
s3_1((3))
s4_1((4))
s1_1 ==> s2_1 ==> s3_1 ==> s4_1
end

subgraph task_2
s1_2((1))
s2_2((2))
s3_2((3))
s4_2((4))
s1_2 ==> s2_2 ==> s3_2 ==> s4_2
end

planner((&))

planner ==> s1_1
planner ==> s1_2

s1_1 -.-> s1_2
s1_2 -.-> s2_1
s2_1 -.-> s2_2
s2_2 -.-> s3_1
s3_1 -.-> s3_2
s3_2 -.-> s4_1
s4_1 -.-> s4_2

s4_1 ==> end_
s4_2 ==> end_

end_((‚Ä¢))

```

```c
#include <stdio.h>
#include <setjmp.h>
#include <unistd.h>

jmp_buf task_a, task_b;
int current = 1;
int i = 0;

void switch_task() {
    if (current == 1) {
        current = 2;
        longjmp(task_b, 1);
    } else {
        current = 1;
        longjmp(task_a, 1);
    }
    sleep(1);
}

void task_A() {
    if (setjmp(task_a) == 0) {} else {
        printf("–ó–∞–¥–∞—á–∞ A, —à–∞–≥ %d\n", i);
        switch_task();
    }
}

void task_B() {
    if (setjmp(task_b) == 0) {} else {
        printf("–ó–∞–¥–∞—á–∞ B, —à–∞–≥ %d\n", i++);
        switch_task();
    }
}

int main() {
    task_A();  // –∑–∞–ø—É—Å–∫–∏ —Å –Ω—É–ª—è–º–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    task_B();  // –∏–ª–∏, —á—Ç–æ —Ç–æ–∂–µ, –∏–Ω–∏—Ü–∏–∞—Ü–∏—è —Ç–æ—á–µ–∫ –≤—Ö–æ–¥–∞ (–≤–æ–∑–≤—Ä–∞—Ç–∞)
    switch_task();
    return 0;
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤

```c
#include <stdio.h>
#include <setjmp.h>
#include <signal.h>

jmp_buf env;

void handler(int sig) {
    printf("–ü–æ–π–º–∞–Ω —Å–∏–≥–Ω–∞–ª %d! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ main()\n", sig);
    longjmp(env, 1);
}

int main() {
    signal(SIGINT, handler);  // –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–≥–Ω–∞–ª–∞ SIGINT
    
    if (setjmp(env) == 0) {
        while (1) {
            printf("–†–∞–±–æ—Ç–∞–µ–º... (–Ω–∞–∂–º–∏ Ctrl+C –¥–ª—è —Ç–µ—Å—Ç–∞)\n");
            sleep(1);
        }
    } else {
        printf("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ —Å–∏–≥–Ω–∞–ª–∞\n");
    }
    return 0;
}
```

`SIGSEGV` ‚Äî —Å–∏–≥–Ω–∞–ª –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–π –ø–∞–º—è—Ç–∏ (–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å)

`SIGFPE` ‚Äî –æ—à–∏–±–∫–∞ –¥–µ–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ–ª–∏–º –Ω–∞ –Ω–æ–ª—å)

`SIGINT` ‚Äî –Ω–∞–∂–∞—Ç–∏–µ Ctrl+C
